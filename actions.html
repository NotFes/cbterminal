<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ... (остальные meta-теги и стили остаются без изменений) ... -->
</head>
<body class="p-4 flex flex-col items-center min-h-screen">
    <!-- ... (весь HTML остаётся без изменений) ... -->

    <script type="module">
        // --- Supabase Configuration ---
        const SUPABASE_URL = 'https://vnfswyztlwgkhkkmhhhs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuZnN3eXp0bHdna2hra21oaGhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4Mjg0MzYsImV4cCI6MjA2MzQwNDQzNn0.jvs2X_61LZaZxcmDoSK9ZRnHo-S2wblifiV4Vogdkyo';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Инициализация пользователя ---
        let userId;
        let isAuthReady = false;

        async function initializeUserId() {
            return new Promise(resolve => {
                const urlParams = new URLSearchParams(window.location.search);
                const cabinetIdFromUrl = urlParams.get('cabinet_id');

                if (cabinetIdFromUrl) {
                    userId = cabinetIdFromUrl;
                    console.log("ID кабинета получен из URL:", userId);
                } else {
                    const storedUserId = localStorage.getItem('userGameId');
                    if (storedUserId) {
                        userId = storedUserId;
                        console.log("ID кабинета загружен из localStorage:", userId);
                    } else {
                        userId = crypto.randomUUID();
                        localStorage.setItem('userGameId', userId);
                        console.log("Сгенерирован новый ID кабинета:", userId);
                    }
                }
                isAuthReady = true;
                resolve();
            });
        }

        // --- Сохранение состояния ---
        const saveGameState = async () => {
            if (!isAuthReady || !userId) {
                console.warn("ID кабинета не готов. Сохранение невозможно.");
                return;
            }
            
            try {
                // Обновляем только баланс, не трогаем terminal_id
                const { error: balanceError } = await supabaseClient
                    .from('cabinet_accounts')
                    .upsert({ 
                        id: userId, 
                        balance: playerCash.toFixed(2) 
                    }, { 
                        onConflict: 'id' 
                    });

                if (balanceError) throw balanceError;

                const playerGameData = {
                    playerPortfolio,
                    futuresPositions,
                    pendingOrders
                };

                const { error: gameDataError } = await supabaseClient
                    .from('game_states')
                    .upsert({ 
                        user_id: userId, 
                        game_data: playerGameData 
                    }, { 
                        onConflict: 'user_id' 
                    });

                if (gameDataError) throw gameDataError;

                const { error: marketError } = await supabaseClient
                    .from('global_market_data')
                    .upsert({ 
                        id: 'market_data', 
                        stocks_data: stocks, 
                        last_news: newsFeedDiv.firstChild?.textContent || 'Нет новостей' 
                    }, { 
                        onConflict: 'id' 
                    });

                if (marketError) throw marketError;
                
            } catch (e) {
                console.error("Ошибка сохранения:", e);
            }
        };

        // --- Загрузка состояния ---
        const loadGameState = async () => {
            if (!isAuthReady || !userId) {
                console.warn("ID кабинета не готов. Загрузка невозможна.");
                return;
            }

            try {
                // Загружаем баланс (без изменения terminal_id)
                const { data: balanceData, error: balanceError } = await supabaseClient
                    .from('cabinet_accounts')
                    .select('balance')
                    .eq('id', userId)
                    .single();

                if (balanceError && balanceError.code !== 'PGRST116') throw balanceError;
                
                playerCash = balanceData?.balance ? parseFloat(balanceData.balance) : 10000;
                console.log("Баланс загружен:", playerCash);

                // Создаем запись, если не существует (без terminal_id)
                if (!balanceData) {
                    const { error: insertError } = await supabaseClient
                        .from('cabinet_accounts')
                        .insert({ 
                            id: userId, 
                            balance: 10000.00 
                        });
                    if (insertError) throw insertError;
                }

                // ... (остальная часть loadGameState остается без изменений) ...
                
            } catch (e) {
                console.error("Ошибка загрузки:", e);
                playerCash = 10000;
                playerPortfolio = [];
                futuresPositions = [];
                pendingOrders = [];
                stocks = JSON.parse(JSON.stringify(initialStocks));
                if (stocks.length > 0) selectedStock = stocks[0];
            }
            
            updateUI();
            startSimulationLoop();
            startNewsGeneration();
        };

        // ... (остальной код остается без изменений) ...

        // Инициализация при загрузке
        window.onload = async function() {
            await initializeUserId();
            loadGameState();
        };
    </script>
</body>
</html>
